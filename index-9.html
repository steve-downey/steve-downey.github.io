<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="Stuff, and more stuff">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>What Comes to Mind (old posts, page 9) | What Comes to Mind</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.1/css/all.min.css" crossorigin="anonymous">
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,900" rel="stylesheet">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="rss.xml">
<link rel="alternate" type="application/atom+xml" title="Atom" hreflang="en" href="feed.atom">
<link rel="canonical" href="https://sdowney.org/index-9.html">
<link rel="prev" href="." type="text/html">
<link rel="next" href="index-8.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Header and menu bar -->
<div class="container">
      <header class="blog-header py-3"><div class="row nbb-header align-items-center">
          <div class="col-md-3 col-xs-2 col-sm-2" style="width: auto;">
            <button class="navbar-toggler navbar-light bg-light nbb-navbar-toggler" type="button" data-toggle="collapse" data-target=".bs-nav-collapsible" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse bs-nav-collapsible bootblog4-search-form-holder">
                
            </div>
        </div>
          <div class="col-md-6 col-xs-10 col-sm-10 bootblog4-brand" style="width: auto;">
            <a class="navbar-brand blog-header-logo text-dark" href=".">

            <span id="blog-title">What Comes to Mind</span>
        </a>
          </div>
            <div class="col-md-3 justify-content-end align-items-center bs-nav-collapsible collapse flex-collapse bootblog4-right-nav">
            <nav class="navbar navbar-light bg-white"><ul class="navbar-nav bootblog4-right-nav"></ul></nav>
</div>
    </div>
</header><nav class="navbar navbar-expand-md navbar-light bg-white static-top"><div class="collapse navbar-collapse bs-nav-collapsible" id="bs-navbar">
            <ul class="navbar-nav nav-fill d-flex w-100">
<li class="nav-item">
<a href="archive.html" class="nav-link">Archives</a>
                </li>
<li class="nav-item">
<a href="categories/index.html" class="nav-link">Tags</a>
                </li>
<li class="nav-item">
<a href="mailto:sdowney@sdowney.dev" class="nav-link"><i class="fa fa-envelope"></i></a>
                </li>
<li class="nav-item">
<a href="https://github.com/steve-downey" class="nav-link">GitHub <i class="fa-brands fa-square-github"></i></a>
                </li>
<li class="nav-item">
<a href="https://mastodon.social/@Sdowney" class="nav-link">Mastodon <i class="fa-brands fa-mastodon"></i></a>
                </li>
<li class="nav-item">
<a href="https://bsky.app/profile/sdowney.bsky.social" class="nav-link">Bluesky <i class="fa-brands fa-square-bluesky"></i></a>
                </li>
<li class="nav-item">
<a href="feed.atom" class="nav-link">ATOM <i class="fa-solid fa-atom"></i></a>
                </li>
<li class="nav-item">
<a href="rss.xml" class="nav-link">RSS <i class="fa-solid fa-rss"></i></a>

                
            </li>
</ul>
</div>
<!-- /.navbar-collapse -->
</nav>
</div>

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        
    
        

    
        
    <div class="postindex">
            <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/index.php/2020/09/30/value-oriented-programming-a-manifesto/" class="u-url">Value Oriented Programming: A Manifesto</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        Steve Downey
                    </span></p>
            <p class="dateline">
            <a href="posts/index.php/2020/09/30/value-oriented-programming-a-manifesto/" rel="bookmark">
            <time class="published dt-published" datetime="2020-09-30T00:00:00-04:00" itemprop="datePublished" title="2020-09-30 00:00">2020-09-30 00:00</time></a>
            </p>
                </div>
            </header><div class="p-summary entry-summary">
                    <div>
<div id="outline-container-org5372f25" class="outline-2">
<h3 id="org5372f25">Object Oriented Programming</h3>
<div class="outline-text-2" id="text-org5372f25">
 The primitive entities are objects which have certain properties

<ul class="org-ul">
<li>Objects have Identity</li>
<li>Objects have State</li>
<li>Objects have Behavior</li>
</ul>
</div>
</div>

<div id="outline-container-orgae5a05b" class="outline-2">
<h3 id="orgae5a05b">Values are not Objects</h3>
<div class="outline-text-2" id="text-orgae5a05b">
 The primitive entities are values which have none of the properties of Objects

<ul class="org-ul">
<li>Values have no identity</li>
<li>Values have no State</li>
<li>Values have no Behavior</li>
</ul>
</div>
</div>

<div id="outline-container-org559c00a" class="outline-2">
<h3 id="org559c00a">A positive definition of VOP</h3>
<div class="outline-text-2" id="text-org559c00a">
<ul class="org-ul">
<li>Values are Equivalent</li>
<li>Values are Immutable</li>
<li>Values are Side-effect Free</li>
</ul>
</div>
</div>

<p class="more"><a href="posts/index.php/2020/09/30/value-oriented-programming-a-manifesto/">Read more…</a></p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/index.php/2019/07/11/anyduck-a-value-type-erased-type/" class="u-url">AnyDuck : A Value Type Erased Type</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        Steve Downey
                    </span></p>
            <p class="dateline">
            <a href="posts/index.php/2019/07/11/anyduck-a-value-type-erased-type/" rel="bookmark">
            <time class="published dt-published" datetime="2019-07-11T23:10:00-04:00" itemprop="datePublished" title="2019-07-11 23:10">2019-07-11 23:10</time></a>
            </p>
                </div>
            </header><div class="p-summary entry-summary">
                    <div id="outline-container-org9373ade" class="outline-2">
<h3 id="org9373ade">A Constrained Duck Typed Value Type</h3>
<div class="outline-text-2" id="text-org9373ade">
 For yak shaving reasons, I need a type able to hold any type conforming to a particular interface. I'd like this to act as a (Semi)Regular value type. That is, I'd like it to be copyable, assignable, and so forth, and not be sliced or otherwise mangeled in the process. I want it to be reasonably efficient, not significantly worse than traditional virtual function overhead. I also don't want to be terribly creative in implementing, using existing std library types.

The overall pattern I've settled on for now is to hold the type in a <code>std::any</code> and dispatch to the held type through function pointers referring to lambdas. The lambda allows me to capture the type being stored into the <code>AnyDuck</code> and safely recover it. There's some boilerplate to write to dispatch to the lambda. Perhaps one day, when we have reflection, that can be automated.

For purposes of this paper, I'll assume I have an interface Duck that I want to model:
<div class="org-src-container">
<pre class="src src-C++"><span class="org-keyword">class</span> <span class="org-type">Duck</span> {
  <span class="org-keyword">public</span>:
    <span class="org-type">void</span> <span class="org-function-name">quack</span>(<span class="org-type">int</span> <span class="org-variable-name">length</span>) <span class="org-keyword">const</span>;
};
</pre>
</div>
Ducks are defined as things that quack, and quack is a const function. I want to be able to put any type that models Duck into an AnyDuck, and pass AnyDuck into any generic function expecting a Duck. I also want to be able to extend AnyDuck to unrelated types, as long as they model Duck. Mallard, for example:
<div class="org-src-container">
<pre class="src src-c++"><span class="org-keyword">class</span> <span class="org-type">Mallard</span> {
  <span class="org-keyword">public</span>:
    <span class="org-type">void</span> <span class="org-function-name">quack</span>(<span class="org-type">int</span> <span class="org-variable-name">length</span>) <span class="org-keyword">const</span>;
};

</pre>
</div>
The core of the idea, is to capture the Duck type in a templated constructor where I know the exact type, and create the appropriate lambda:
<div class="org-src-container">
<pre class="src src-C++"><span class="org-keyword">auto</span> <span class="org-variable-name">quack_</span> = [](<span class="org-constant">std</span>::<span class="org-type">any</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">d</span>, <span class="org-type">int</span> <span class="org-variable-name">i</span>) {
    <span class="org-keyword">return</span> <span class="org-constant">std</span>::any_cast&lt;<span class="org-constant">std</span>::<span class="org-type">remove_reference_t</span>&lt;Duck&gt;&gt;(&amp;d)-&gt;quack(i);
}
</pre>
</div>
And then wrap the public facing call so that quackfn can be stored as a function pointer
<div class="org-src-container">
<pre class="src src-C++"><span class="org-type">void</span> <span class="org-constant">AnyDuck</span>::<span class="org-function-name">quack</span>(<span class="org-type">int</span> <span class="org-variable-name">length</span>) <span class="org-keyword">const</span> { <span class="org-keyword">return</span> quack_(<span class="org-keyword">this</span>-&gt;duck_, length); }
</pre>
</div>
Here's the whole thing:
<div class="org-src-container">
<pre class="src src-c++"><span class="org-keyword">class</span> <span class="org-type">AnyDuck</span> {
    <span class="org-constant">std</span>::<span class="org-type">any</span> <span class="org-variable-name">duck_</span>;
    <span class="org-keyword">using</span> <span class="org-type">quackfn</span> = <span class="org-type">void</span> (*)(<span class="org-constant">std</span>::<span class="org-type">any</span> <span class="org-keyword">const</span>&amp;, <span class="org-type">int</span>);
    <span class="org-type">quackfn</span> <span class="org-variable-name">quack_</span>;

  <span class="org-keyword">public</span>:
    <span class="org-function-name">AnyDuck</span>(<span class="org-type">AnyDuck</span> <span class="org-keyword">const</span>&amp;) = <span class="org-keyword">default</span>;
    <span class="org-function-name">AnyDuck</span>(<span class="org-type">AnyDuck</span>&amp;)       = <span class="org-keyword">default</span>;

    <span class="org-keyword">template</span> &lt;<span class="org-keyword">typename</span> <span class="org-type">Duck</span>&gt;
    <span class="org-function-name">AnyDuck</span>(<span class="org-type">Duck</span>&amp;&amp; <span class="org-variable-name">duck</span>)
        : duck_(<span class="org-constant">std</span>::forward&lt;<span class="org-type">Duck</span>&gt;(duck)),
          quack_([](<span class="org-constant">std</span>::<span class="org-type">any</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">d</span>, <span class="org-type">int</span> <span class="org-variable-name">i</span>) {
              <span class="org-keyword">return</span> <span class="org-constant">std</span>::any_cast&lt;<span class="org-constant">std</span>::<span class="org-type">remove_reference_t</span>&lt;<span class="org-type">Duck</span>&gt;&gt;(&amp;d)-&gt;quack(
                  i);
          }) {}

    <span class="org-type">void</span> <span class="org-function-name">quack</span>(<span class="org-type">int</span> <span class="org-variable-name">length</span>) <span class="org-keyword">const</span> { <span class="org-keyword">return</span> quack_(<span class="org-keyword">this</span>-&gt;duck_, length); }
};
</pre>
</div>
The copy constructors are there to be a better match than the templated constructor for copy by value. Codegen is surprisingly good. If the types are all present, the functions are inlined well, except for the overhead of storage into the any. For any unknown AnyDuck, there's a dispatch via pointer indirection:
<div class="org-src-container">
<pre class="src src-c++"><span class="org-type">void</span> <span class="org-function-name">test</span>(<span class="org-type">AnyDuck</span> <span class="org-variable-name">a</span>) {
    a.quack(1);
}
</pre>
</div>
results in something like
<div class="org-src-container">
<pre class="src src-asm"><span class="org-function-name">0000000000000050</span> &lt;test(scratch::AnyDuck)&gt;:
  <span class="org-keyword">50</span>:   48 8b 47 10             mov    0x10(<span class="org-variable-name">%rdi</span>),<span class="org-variable-name">%rax</span>
  <span class="org-keyword">54</span>:   be 01 00 00 00          mov    $0x1,<span class="org-variable-name">%esi</span>
  <span class="org-keyword">59</span>:   ff e0                   jmpq   *<span class="org-variable-name">%rax</span>
  <span class="org-keyword">5b</span>:   0f 1f 44 00 00          nopl   0x0(<span class="org-variable-name">%rax</span>,<span class="org-variable-name">%rax</span>,1)

</pre>
</div>
and the <code>any_cast&lt;&gt;</code> from the address of the passed in std::any is noexcept, but does in general have to check if the <code>any</code> has a value. Not as cheap as pure an interface type, but not terribly more expensive.

For the case where the <code>quack</code> is known, codegen is something like
<div class="org-src-container">
<pre class="src src-asm"><span class="org-function-name">scratch</span>::AnyDuck::AnyDuck&lt;Duck&amp;&gt;(Duck&amp;)::{lambda(std::any const&amp;, int)#1}::__invoke(std::any const&amp;, int): # @scratch::AnyDuck::AnyDuck&lt;Duck&amp;&gt;(Duck&amp;)::{lambda(std::any const&amp;, int)#1}::__invoke(std::any const&amp;, int)
        <span class="org-keyword">movl</span>    <span class="org-variable-name">%esi</span>, <span class="org-variable-name">%edi</span>
        <span class="org-keyword">jmp</span>     bell(int)                # TAILCALL
</pre>
</div>
If the implementation of the underlying quack is not available there's a little more work
<div class="org-src-container">
<pre class="src src-asm"><span class="org-function-name">scratch</span>::AnyDuck::AnyDuck&lt;Mallard&amp;&gt;(Mallard&amp;)::{lambda(std::any const&amp;, int)#1}::__invoke(std::any const&amp;, int): # @scratch::AnyDuck::AnyDuck&lt;Mallard&amp;&gt;(Mallard&amp;)::{lambda(std::any const&amp;, int)#1}::__invoke(std::any const&amp;, int)
        <span class="org-keyword">movl</span>    $_ZNSt3any17_Manager_internalI7MallardE9_S_manageENS_3_OpEPKS_PNS_4_ArgE, <span class="org-variable-name">%ecx</span>
        <span class="org-keyword">xorl</span>    <span class="org-variable-name">%eax</span>, <span class="org-variable-name">%eax</span>
        <span class="org-keyword">cmpq</span>    <span class="org-variable-name">%rcx</span>, (<span class="org-variable-name">%rdi</span>)
        <span class="org-keyword">leaq</span>    8(<span class="org-variable-name">%rdi</span>), <span class="org-variable-name">%rcx</span>
        <span class="org-keyword">cmoveq</span>  <span class="org-variable-name">%rcx</span>, <span class="org-variable-name">%rax</span>
        <span class="org-keyword">movq</span>    <span class="org-variable-name">%rax</span>, <span class="org-variable-name">%rdi</span>
        <span class="org-keyword">jmp</span>     Mallard::quack(int) const    # TAILCALL
</pre>
</div>
But far less than I would have expected. <code>std::any</code> is less awful than I thought.

You can take a look at the code so far here <a href="https://godbolt.org/#z:OYLghAFBqd5QCxAYwPYBMCmBRdBLAF1QCcAaPECAKxAEZSAbAQwDtRkBSAJgCFufSAZ1QBXYskwgA5NwDMeFsgYisAag6yAwqwCeG7BwAMAQTkKlKzOq0EdAB0wB9AsSaFB%2Bo6ZMsmAW0xBOyYJVUFkVwJkBHUAdj4TLyUmQUFVYxYdABERZABrOITjVRKwgnQQEF1VdFy8xw0i0tURQQVgVQBHERC8gDMWayzVADdUPHRVCAAqAEoIQXLK6rQWRe4ANlJVBQJZxq9m7t6Brp78htkiw9U7EQAjBjxkEBuSjOy6iA%2Bc/NVV9ZcDazIY1TB9JgiBgEA4mZo/L4I/KbEEaYZYCFQmFXN7pTK/PIQVGydHgyHQ2HeYqlAiYPx2Zi06yaWwOXwBVQEzxw0pIwlcoGbGp1fY85olEDCi4LJYgPokADuTGI6A0mi5smwEFq%2BVms1IuPFZ16jggHAArHxzVkZRUqpl/qg1jCgTVtrsdqj4oajaViJgCGJBos7bpHMgUtjNCHKv6/KgRk5/X1MP7FE4oxqDJqzUD0LMALT6Y75M1i30VvD7HHlo0cWJZL18BteXFjCbG0sehiYNgEBAggEEQqqf2B4iDEv1CD9vCCIuanX1bY9vsDxpxLKtls1qn14YAegPqnZgWCoXCkWirZMmAAHrSJ6NxpN7pgGAwIB6q5SksxUpydSFDcdyPM8rzlu2kxTl%2BLDDquwD9oOTqLIUY5Bqob4fhACFIQcLaJDu1wmMkAEALJMB%2ByqTPWTS3A8TwvG2L6doS3a9ohA6Os6v5ETexhHs%2BHYUVRKqVDB7FrshzrASYgnNDGKCiMOapquoXBcCJzBiepXDMmpuExKpWiqGAMjmpoLBmZSgn7vxUGqLSiwQFp1FCn4lHafmsnUiUl5MFESAgHyqhMBAHmifmlLNEwAB0MG0NW1wEVSDlOQQCwRAF0SVCFQ5CkwTa4nFCVJduW6JJVxgeh5CiwcOB7TMqwDINMB7bNEyrTNMqiNc1IxtaKpjeuWrTtCe/hniEVj%2BYF0WlASNTzX5WWBbl%2BJAWFUW7jF8XnISiW/uWglDoBfzIKqO2lIJs05cFG3nWFF1lcdx4RntvQQIdu64jdq13SF/guZ5bneg2L2%2Bb1x7%2BB9pZcBDv3HulwORbR%2B4Q80gnI4VR2Q4t6BcMtNRcLDhLw7xFXGFI%2BoMNI5pSKQLDSIYDOoNImj8PwYSiOIVhyLQDMEMz1P6nkICyAALLFsS0BssRy4YEu0AAnAAHLIhixIw0gSwzTNSCzpBs1IDOCCAhikELBvU6QcCwEgaD0ngPZkBQECO3YzupigzBsKrhgW30zuPmbED3MLpD3Aoyo6NIAukI7ARwQA8iwDCx9bpBYB5bA9hH%2BD%2BsgBB4ImZuZ/emDICItJxwzuzvrXjB4PcrjEDomgYJImcuHgfi1zTrDsJzvBN/cZuwKeKB%2BMgiwMFwpCJsQIAuCILB5HqRt2MXKHSAWyeyKoBYhminC8PwXBMKops8xIdA03TesR8bd6qxsBYbBL/y%2Bx0quxYYf9TFwIQEg6lZD0FUB3J2LtQGJQgcPHggthYbzFmA2KysJZq2VsrDYXAJYbHVlsWmUhdaMyftIU25tLZINtjARAIBlJ3AIOQSgHsvZL3oJgfARB2GkAVK4Ow/dtZSHpqQzOxt%2BaqAVIQGIL834fy/oPVQv9/6GytizZB4tZCxVkDo3Rei9FCJIfrQ2xsKEWzUSLIRXAGZ91oAHURJjyFUOthvRebQnQgAlkAA">Compiler Explorer Link to see the results</a>

I'll clean up my scratch project and push it at some point.

</div>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/index.php/2019/04/20/steve-downeys-birthday-observed/" class="u-url">Steve Downey's Birthday (Observed)</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        Steve Downey
                    </span></p>
            <p class="dateline">
            <a href="posts/index.php/2019/04/20/steve-downeys-birthday-observed/" rel="bookmark">
            <time class="published dt-published" datetime="2019-04-20T23:37:22-04:00" itemprop="datePublished" title="2019-04-20 23:37">2019-04-20 23:37</time></a>
            </p>
                </div>
            </header><div class="p-summary entry-summary">
                    <p><strong>LOCATION:</strong></p>
<p style="padding-left: 40px;"><a href="https://goo.gl/maps/N58DLiZe9P4fQ9KM9" target="_blank" rel="noopener noreferrer">Blooms Tavern</a><br>208 East 58th Street<br>Between 2nd &amp; 3rd Ave<br>New York, NY 10022</p>
<p><strong>TIME:</strong></p>
<p style="padding-left: 40px;">6:00 PM -&gt;</p>
<p><strong>Description:</strong></p>
<p style="padding-left: 40px;">This is the sound<br>I bought a ticket to the world<br>But now I've come back again<br>Why do I find it hard to write the next line?<br>Oh, I want the truth to be said<br>I know this much is true</p>
<p style="padding-left: 40px;"><strong>DIRECTIONS:</strong></p>
<p>From: <strong>110 W 14th St</strong></p>
<table><tbody><tr>
<td>
<p><img class="wp-image-227" src="http://www.sdowney.org/wordpress/wp-content/uploads/2019/04/walk.png" alt="Walk"> Walk</p>
<p>About 2 min , 335 ft</p>
<p>6:03 PM</p>
<h3>14 Street Station</h3>
<p><img class="wp-image-228" src="http://www.sdowney.org/wordpress/wp-content/uploads/2019/04/l.png" alt="L"> Canarsie - Rockaway Pkwy</p>
<p>2 min (non-stop)</p>
<p>6:05 PM</p>
<h3>14 Street - Union Sq Station</h3>
<p><img class="wp-image-229" src="http://www.sdowney.org/wordpress/wp-content/uploads/2019/04/walk-1.png" alt="Walk"> Walk</p>
<p>About 1 min</p>
<p>6:09 PM</p>
<h3>14 Street - Union Sq Station</h3>
<p><img class="wp-image-230" src="http://www.sdowney.org/wordpress/wp-content/uploads/2019/04/5x.png" alt="5X"> Eastchester - Dyre Av</p>
<p>7 min (2 stops)</p>
<p>6:16 PM</p>
<h3>59 St-Lexington Av Station</h3>
<p><img class="wp-image-231" src="http://www.sdowney.org/wordpress/wp-content/uploads/2019/04/walk-2.png" alt="Walk"> Walk</p>
<p>About 4 min , 0.2 mi</p>
<p>6:20 PM</p>
<h3><strong>Blooms Tavern</strong></h3>
<p>208 E 58th St, New York, NY 10022</p>
</td>
<td>
<p><img class="wp-image-232" src="http://www.sdowney.org/wordpress/wp-content/uploads/2019/04/walk-3.png" alt="Walk"> Walk</p>
<p>About 2 min , 0.1 mi</p>
<p>6:03 PM</p>
<h3>14 Street Station</h3>
<p><img class="wp-image-233" src="http://www.sdowney.org/wordpress/wp-content/uploads/2019/04/m.png" alt="M"> Forest Hills - 71 Av</p>
<p>13 min (6 stops)</p>
<p>6:16 PM</p>
<h3>Lexington Av-53 St</h3>
<p><img class="wp-image-234" src="http://www.sdowney.org/wordpress/wp-content/uploads/2019/04/walk-4.png" alt="Walk"> Walk</p>
<p>About 6 min , 0.3 mi</p>
<p>6:22 PM</p>
<h3><strong>Blooms Tavern</strong></h3>
<p>208 E 58th St, New York, NY 10022</p>
</td>
</tr></tbody></table>
<p>From: <b>731 Lexington Avenue</b></p>
<p><span style="font-weight: 400;">Head southwest on Beacon Ct toward E 58th St<br></span>Restricted usage road<br>184 ft</p>
<p><span style="font-weight: 400;">Turn left onto E 58th St<br></span>Pass by Wells Fargo Bank (on the left in 115 ft)<br>Destination will be on the right<br>420 ft</p>
<h3><b>Bloom's Tavern</b></h3>
<p><span style="font-weight: 400;">208 E 58th St, New York, NY 10022</span></p>

<!-- wp:image {"id":236} -->
<figure class="wp-block-image"><img src="http://www.sdowney.org/wordpress/wp-content/uploads/2019/04/IMAG0172_1-723x1024.jpg" alt="" class="wp-image-236"></figure><!-- /wp:image -->
</div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/index.php/2018/12/02/building-saar-razs-clang-concepts-branch/" class="u-url">Building Saar Raz's clang concepts branch</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        Steve Downey
                    </span></p>
            <p class="dateline">
            <a href="posts/index.php/2018/12/02/building-saar-razs-clang-concepts-branch/" rel="bookmark">
            <time class="published dt-published" datetime="2018-12-02T00:00:00-05:00" itemprop="datePublished" title="2018-12-02 00:00">2018-12-02 00:00</time></a>
            </p>
                </div>
            </header><div class="p-summary entry-summary">
                    <div id="outline-container-org1603cfb" class="outline-2">
<h3 id="org1603cfb">A Recipe for building Saar Raz's clang concepts branch</h3>
<div class="outline-text-2" id="text-org1603cfb">
 Saar Raz has been working on a Concepts implementation, available at <a href="https://github.com/saarraz/clang-concepts">https://github.com/saarraz/clang-concepts</a> It's not much harder to build it than clang usually is, it's just a matter of getting things checked out into the right places before configuring the build. Just like LLVM and clang normally. 

 In order to double check how, I peeked at the shell script used by the compiler explorer image to build the clang-concepts compiler: <a href="https://github.com/mattgodbolt/compiler-explorer-image/blob/master/clang/build/build-concepts.sh">https://github.com/mattgodbolt/compiler-explorer-image/blob/master/clang/build/build-concepts.sh</a> 

 The really important bit is getting exactly the right commit from LLVM, 893a41656b527af1b00a1f9e5c8fcecfff62e4b6. 

 To get a working directory something like: Starting from where you want your working tree and build tree, e.g ~/bld/llvm-concepts 

<div class="org-src-container">
<pre class="src src-shell">git clone https://github.com/llvm-mirror/llvm.git

<span class="org-builtin">pushd</span> llvm
git reset --hard 893a41656b527af1b00a1f9e5c8fcecfff62e4b6
<span class="org-builtin">popd</span>

<span class="org-builtin">pushd</span> llvm/tools
git clone https://github.com/saarraz/clang-concepts.git clang
<span class="org-builtin">popd</span>

<span class="org-builtin">pushd</span> llvm/projects
git clone https://github.com/llvm-mirror/libcxx.git
git clone https://github.com/llvm-mirror/libcxxabi.git
<span class="org-comment-delimiter"># </span><span class="org-comment">The sanitizers: this is optional but you want them</span>
git clone https://github.com/llvm-mirror/compiler-rt.git
<span class="org-builtin">popd</span>

</pre>
</div>

 Then to build and install 

<div class="org-src-container">
<pre class="src src-shell">mkdir build &amp;&amp; <span class="org-builtin">cd</span> build

cmake <span class="org-sh-escaped-newline">\</span>
    -DCMAKE_INSTALL_PREFIX=~/install/llvm-concepts/ <span class="org-sh-escaped-newline">\</span>
    -DLLVM_ENABLE_LIBCXX=yes  <span class="org-sh-escaped-newline">\</span>
    -DCMAKE_BUILD_TYPE=Release  <span class="org-sh-escaped-newline">\</span>
    -DLLVM_ENABLE_ASSERTIONS=yes <span class="org-sh-escaped-newline">\</span>
    -DLLVM_PARALLEL_LINK_JOBS=1 <span class="org-sh-escaped-newline">\</span>
    -G Ninja  <span class="org-sh-escaped-newline">\</span>
    ../llvm/

ninja

ninja check

ninja install
</pre>
</div>

 Note that I install into a separate prefix, keeping it isolated from everything else. The compiler can be invoked as ~/install/llvm-concepts/bin/clang++. There's no particular reason to put the compiler on your PATH. 
</div>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/index.php/2018/10/14/should-unicode-literals-be-guaranteed-to-be-well-formed/" class="u-url">Should Unicode literals be guaranteed to be well-formed?</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        Steve Downey
                    </span></p>
            <p class="dateline">
            <a href="posts/index.php/2018/10/14/should-unicode-literals-be-guaranteed-to-be-well-formed/" rel="bookmark">
            <time class="published dt-published" datetime="2018-10-14T00:00:00-04:00" itemprop="datePublished" title="2018-10-14 00:00">2018-10-14 00:00</time></a>
            </p>
                </div>
            </header><div class="p-summary entry-summary">
                    <p>TL;DR Betteridge's law applies: No. 

 Are you still here? 

</p>
<div id="outline-container-org399ca07" class="outline-2">
<h3 id="org399ca07">Unicode Literals</h3>
<div class="outline-text-2" id="text-org399ca07">
 In C++ 20 there are 2 kinds and 6 forms of Unicode literals. Character literals and string literals, in UTF-8, UTF-16, and UTF-32 encodings. Each of them uses a distinct char type to signal in the type system what the encoding is for the data. For plain <code>char</code> literals, the encoding is the execution character set, which is implementation defined. It might be something useful, like UTF-8, or old, like UCS-2, or something distinctly unhelpful, like EBCDIC. Whatever it is, it was fixed at compilation time, and is not affected by things like LOCALE settings. The source character set is the encoding the compiler believes your source code is written in. Including the octets that happen to be between <code>"</code> and <code>'</code> characters. 

<div class="org-src-container">
<pre class="src src-C++"><span class="org-type">char32_t</span> <span class="org-variable-name">s1</span>[] = <span class="org-constant">U</span><span class="org-string">"\u0073tring"</span>;
<span class="org-type">char16_t</span> <span class="org-variable-name">s2</span>[] = <span class="org-constant">U</span><span class="org-string">"\u0073tring"</span>;
<span class="org-type">char8_t</span> <span class="org-variable-name">s2</span>[] = <span class="org-constant">U</span><span class="org-string">"\u0073tring"</span>;

<span class="org-type">char32_t</span> <span class="org-variable-name">c1</span> = U<span class="org-warning">'</span>\u0073<span class="org-warning">'</span>;
<span class="org-type">char16_t</span> <span class="org-variable-name">c1</span> = u<span class="org-warning">'</span>\u0073<span class="org-warning">'</span>;
<span class="org-type">char8_t</span> <span class="org-variable-name">c1</span> = u8<span class="org-warning">'</span>\u0073<span class="org-warning">'</span>;
</pre>
</div>

 Unicode codepoint U+0073 is 's'. So all of the strings are "string", and all of the characters are 's', however the rendering of each in memory is different. For the string types, each unit in the string is 32, 16 or 8 bits respectively, and for the character literals, each is one code unit, again of 32, 16, or 8 bits. 
</div>
</div>

<div id="outline-container-org636cf76" class="outline-2">
<h3 id="org636cf76">Suprises</h3>
<div class="outline-text-2" id="text-org636cf76">
 This is due to Zach Laine, an actual expert, and sorting out what happened took several other experts, so the rest of us have little hope. 

<div class="org-src-container">
<pre class="src src-C++"><span class="org-type">char8_t</span> <span class="org-variable-name">suprise</span>[] = <span class="org-constant">u8</span><span class="org-string">"ς"</span>;
assert(strlen(surprise) == 5);
</pre>
</div>

 This comes down to your editor and compiler having a minor disagreement about encoding. The compiler was under the impression that the encoding was cp-1252, where the editor believed it to be UTF-8. The underlying octets for ς are 0xCF 0x82, each of which is a character in cp-1252. All octets are valid characters in cp-1252. So each was converted to UTF-8, resulting in 0xC3 0x8F and 0xE2 0x80 0x9A. 

 Of course. 

 The contents of the string are still in the source character set, not in any of the Unicode forms. Unless that happens to be the source character set. 

 But at least it's well formed. 
</div>
</div>

<div id="outline-container-orgfe5e3b6" class="outline-2">
<h3 id="orgfe5e3b6">Escapes</h3>
<div class="outline-text-2" id="text-orgfe5e3b6">
 The <code>\u</code> escapes, which identify Unicode codepoints by number, will produce well formed Unicode encoding in strings, and in character literals if they fit. That is, in a <code>char32_t</code>, you can put any code point. In a <code>char16_t</code> you can put any character from the basic multilingual plane. In a <code>char8_t</code> you can put 7 bit ASCII characters. 

 Or you can use hex or octal escapes, which will be widened to code unit size and the value placed into the resultant character or string. And no current compiler checks if that makes sense, although they will warn you if, for example you try to write something like: 

<div class="org-src-container">
<pre class="src src-C++"><span class="org-type">char16_t</span> <span class="org-variable-name">w4</span> = u<span class="org-warning">'</span>\x0001f9ff<span class="org-warning">'</span>; <span class="org-comment-delimiter">// </span><span class="org-comment">NAZAR AMULET - Unicode 11.0 (June 2018)</span>
<span class="org-type">char16_t</span> <span class="org-variable-name">sw4</span>[] = <span class="org-constant">u</span><span class="org-string">"\x0001f9ff"</span>;
</pre>
</div>

 where you're trying to put a value that won't fit into a code unit into the result. 

<pre class="example">
warning: hex escape sequence out of range
</pre>

 The <code>\xnn</code> and <code>\nnn</code> hex and octal escapes are currently a hole that lets you construct ill-formed string literals. For example 

<div class="org-src-container">
<pre class="src src-C++"><span class="org-type">char8_t</span> <span class="org-variable-name">oops</span> = <span class="org-constant">u8</span><span class="org-string">"\xfe\xed"</span>;

</pre>
</div>

 But there are lots of ways of constructing ill-formed arrays of <code>char8_t</code> or <code>char16_t</code>. Just spell them out as arrays: 

<div class="org-src-container">
<pre class="src src-C++"><span class="org-type">char8_t</span> <span class="org-variable-name">ill</span> = {<span class="org-keyword">0x</span><span class="org-constant">fe</span>, <span class="org-keyword">0x</span><span class="org-constant">ed</span>};
</pre>
</div>

 The type system doesn't provide that <code>char8_t</code> means well formed UTF-8. All it does is tell you that the intended encoding is UTF-8. Which is a huge improvement over <code>char</code>. 

 But it does not provide any guarantee to an API taking a <code>char8_t*</code>. 
</div>
</div>

<div id="outline-container-org3e19119" class="outline-2">
<h3 id="org3e19119">\0 is an octal escape sequence</h3>
<div class="outline-text-2" id="text-org3e19119">
 You can spell it \u0000. But that's weird, since we spell it as <code>\0</code> everywhere, and that it's an octal escape is a C++ trivia question. 
</div>
</div>

<div id="outline-container-org07823cd" class="outline-2">
<h3 id="org07823cd">I want to be told if I'm forming ill-formed Unicode.</h3>
<div class="outline-text-2" id="text-org07823cd">
 Then don't use escape sequences. If you use either well encoded source code encodings or universal character names you will get well formed Unicode. 

 The primary reason for wanting ill-formed Unicode is for testing. It's a convenience. And there are straightforward workarounds. 

 But disallowing hex and octal escapes in Unicode strings makes the language less regular while preventing an error that you had to go out of your way to create, and does not actually produce more runtime safety. 
</div>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/index.php/2018/06/17/litmus-tests-for-multithreaded-behavior/" class="u-url">Litmus Tests for Multithreaded Behavior</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        Steve Downey
                    </span></p>
            <p class="dateline">
            <a href="posts/index.php/2018/06/17/litmus-tests-for-multithreaded-behavior/" rel="bookmark">
            <time class="published dt-published" datetime="2018-06-17T14:10:15-04:00" itemprop="datePublished" title="2018-06-17 14:10">2018-06-17 14:10</time></a>
            </p>
                </div>
            </header><div class="p-summary entry-summary">
                    <div id="content">
<h2 class="title">Litmus Tests for Multithreaded Behavior

<span class="subtitle">Or How Processors Don't Do What You Think</span>
</h2>
Modern multicore processors are entirely weirder than almost anyone thinks possible. They are somewhat weirder than chip makers were willing to admit until fairly recently. They are sufficiently weird enough that almost all multi-threaded programs, and many lock-free algorithms, had bugs because the hardware just does not work the way anyone would reasonably expect. And, in addition, optimizing compilers did not actually know how to not break your code. [<a href="posts/index.php/2018/06/17/litmus-tests-for-multithreaded-behavior/#boehm2005threads">boehm2005threads</a>]

I'm in the (slow) process of writing some test cases for multi-threaded code. I eventually want to have some confidence that some code is executed once, and only once, in an efficient manner. It's the 'efficient' part that worries me, because for efficient, it also has a tendency to be clever, and I'm learning that clever MT code is often subtly broken. [<a href="posts/index.php/2018/06/17/litmus-tests-for-multithreaded-behavior/#bacon2000double">bacon2000double</a>] So if smarter people than me make mistakes about MT code, I need tests to compensate. And ones that will cover occasional allowed but unexpected behavior. Which means the test framework should be able to detect them.

Also, fortunately, the RPi is a computer that exhibits some odd behavior, as it is an ARM system. X86 has a much stronger model. However, even the x86 model is allowed to perform in odd ways.

Starting in 2007, Intel has started publishing short snippets of assembly and documenting what are the allowed and disallowed results running them in parallel. [<a href="posts/index.php/2018/06/17/litmus-tests-for-multithreaded-behavior/#IWPAug2007">IWPAug2007</a>] These snippets have come to be called litmus tests, and are used to confirm the behavior of hardware, and confirm models of the hardware behavior. A particularly important model for C++ programmers is the x86 Total Store Order model [<a href="posts/index.php/2018/06/17/litmus-tests-for-multithreaded-behavior/#owens2009better">owens2009better</a>] which provides a way of mapping the C++11 memory model to X86 hardware. X86 hardware provides a strongly consistent memory model. Power and ARM provide fewer guarantees, and mapping the C++ memory model to these architectures is more challenging. [<a href="posts/index.php/2018/06/17/litmus-tests-for-multithreaded-behavior/#maranget2012tutorial">maranget2012tutorial</a>]
<div id="outline-container-org6552108" class="outline-2">
<h3 id="org6552108">Message Passing</h3>
<div id="text-org6552108" class="outline-text-2">

The tests outlined in the Intel paper are short pieces of assembly to be exercised on different processors, with guarantees about behavior that will not happen. The first one essentially promises that message passing will work, and is now known as the MP test.
<table border="2" frame="hsides" rules="groups" cellspacing="0" cellpadding="6">
<colgroup>
<col class="org-left">
<col class="org-left">
</colgroup>
<thead><tr>
<th class="org-left" scope="col">Processor 0</th>
<th class="org-left" scope="col">Processor 1</th>
</tr></thead>
<tbody>
<tr>
<td class="org-left">mov [ _x], 1 // M1</td>
<td class="org-left">mov r1, [ _y] // M3</td>
</tr>
<tr>
<td class="org-left">mov [ _y], 1 // M2</td>
<td class="org-left">mov r2, [ _x] // M4</td>
</tr>
</tbody>
</table>
Initially x = y = 0

r1 = 1 and r2 = 0 is not allowed

That says that we can't read the writes of x and y out of order, which ensures that if we're waiting to see the write to the flag y, we can be guaranteed to see the payload in x. If we change it slightly to wait for the write to _y to be visible, we can pass a message from one thread to anothher in _x. This is also known as Dekards Algorithm.

ARM and Power do not provide that guarantee without additional synchronization instructions.

In C++ that looks something like the following, using the test framework I'm writing.
<div class="org-src-container">
<pre class="src src-C++"><span class="org-constant">MP</span>::<span class="org-function-name">MP</span>() : x_(0), y_(0) {}
<span class="org-type">void</span> <span class="org-constant">MP</span>::<span class="org-function-name">t1</span>() {
    x_.store(1, <span class="org-constant">std</span>::memory_order_relaxed);
    y_.store(1, <span class="org-constant">std</span>::memory_order_relaxed);
}
<span class="org-type">void</span> <span class="org-constant">MP</span>::<span class="org-function-name">t2</span>(<span class="org-type">Result</span>&amp; <span class="org-variable-name">read</span>) {
    <span class="org-keyword">while</span> (<span class="org-negation-char">!</span>y_.load(<span class="org-constant">std</span>::memory_order_relaxed)){}
    <span class="org-constant">std</span>::get&lt;0&gt;(read) = x_.load(<span class="org-constant">std</span>::memory_order_relaxed);
}

</pre>
</div>
Here, x_ and y_ are atomic&lt;int&gt;s, and we're using the lowest possible atomic guarantee in C++, relaxed. Relaxed guarantees that the operation happens atomically. but there are no synchronization properties with anything else. This usally corresponds to the basic int type. Unless you're using a really insane processor that might let an int be partially written and observable. Like you might get the top half of the int, or the middle byte. The commercial processors that allowed this have pretty much died out.

The test spins on seeing the load of y to be complete. It loads the value of x_ into a result tuple. The tuple is used as the key to a map which accumulates how many times each result has been seen.
Running the above on my x86 laptop:
<pre class="example">[ RUN      ] ExperimentTest.MPTest1
(1) : 2000000

</pre>
on my Raspberry Pi 3:
<pre class="example">[ RUN      ] ExperimentTest.MPTest1
(0) : 483
(1) : 1999517

</pre>
Using objdump to check the generated assembly
<pre class="example">00000088 &lt;litmus::MP::MP()&gt;:
  88:   mov     r2, #0
  8c:   str     r2, [r0]
  90:   str     r2, [r0, #64]   ; 0x40
  94:   bx      lr

00000098 &lt;litmus::MP::t1()&gt;:
  98:   mov     r3, #1
  9c:   str     r3, [r0]
  a0:   str     r3, [r0, #64]   ; 0x40
  a4:   bx      lr

000000a8 &lt;litmus::MP::t2(std::tuple&lt;int&gt;&amp;)&gt;:
  a8:   ldr     r3, [r0, #64]   ; 0x40
  ac:   cmp     r3, #0
  b0:   beq     a8 &lt;litmus::MP::t2(std::tuple&lt;int&gt;&amp;)&gt;
  b4:   ldr     r3, [r0]
  b8:   str     r3, [r1]
  bc:   bx      lr
</pre>
So, out of the 2,000,000 times that I ran the experiment, there were 483 times that reading x_ resulted in 0, even though y_ was 1. ARM has a weaker memory model than x86. This has some advantages in processor implementation. It has distinct disadvantages in how our brains work. X86 tries to preserve the model that there is shared memory that everyone sees and works with. That's not strictly true, even for X86, but ARM and Power don't even come close. On the other hand, it's also why it's easier to add more cores to Power and ARM chips and systems. I routinely work with Power systems with 512 physical cores.

</div>
</div>
<div id="outline-container-orgdbab232" class="outline-2">
<h3 id="orgdbab232">Store Buffering</h3>
<div id="text-orgdbab232" class="outline-text-2">

Store buffering is the odd case that is allowed in the Intel memory model. When assigning locations in two threads, and then reading them on opposite threads, both threads are allowed to read the older state. The stores get buffered.
From the Intel White Paper:
<table border="2" frame="hsides" rules="groups" cellspacing="0" cellpadding="6">
<colgroup>
<col class="org-left">
<col class="org-left">
</colgroup>
<thead><tr>
<th class="org-left" scope="col">Processor 0</th>
<th class="org-left" scope="col">Processor 1</th>
</tr></thead>
<tbody>
<tr>
<td class="org-left">mov [ _x], 1 // M1</td>
<td class="org-left">mov [ _y], 1 // M3</td>
</tr>
<tr>
<td class="org-left">mov r1, [ _y] // M2</td>
<td class="org-left">mov r2, [ _x] // M4</td>
</tr>
</tbody>
</table>
Initially x = y = 0

r1 = 0 and r2 ==0 is allowed

Note, in particular, there is no interleaving of M1 - 4 that could result in r1 and r2 being 0. Not without interupting an instruction in the middle. But the instructions themselves are atomic, and indivisible. If they were actually operating on shared memory, this would not be possible. However, it does happen.
<div class="org-src-container">
<pre class="src src-c++"><span class="org-constant">SB</span>::<span class="org-function-name">SB</span>() : x_(0), y_(0) {}
<span class="org-type">void</span> <span class="org-constant">SB</span>::<span class="org-function-name">t1</span>(<span class="org-type">Result</span>&amp; <span class="org-variable-name">read</span>) {
    y_.store(1, <span class="org-constant">std</span>::memory_order_relaxed);
    <span class="org-constant">std</span>::get&lt;0&gt;(read) = x_.load(<span class="org-constant">std</span>::memory_order_relaxed);
}
<span class="org-type">void</span> <span class="org-constant">SB</span>::<span class="org-function-name">t2</span>(<span class="org-type">Result</span>&amp; <span class="org-variable-name">read</span>) {
    x_.store(1, <span class="org-constant">std</span>::memory_order_relaxed);
    <span class="org-constant">std</span>::get&lt;1&gt;(read) = y_.load(<span class="org-constant">std</span>::memory_order_relaxed);
}

</pre>
</div>
That generates the x86 code
<pre class="example">00000000000000f0 &lt;litmus::SB::t1(std::__1::tuple&lt;int, int&gt;&amp;)&gt;:
  f0:   mov    DWORD PTR [rdi+0x40],0x1
  f7:   mov    eax,DWORD PTR [rdi]
  f9:   mov    DWORD PTR [rsi],eax
  fb:   ret

0000000000000100 &lt;litmus::SB::t2(std::__1::tuple&lt;int, int&gt;&amp;)&gt;:
 100:   mov    DWORD PTR [rdi],0x1
 106:   mov    eax,DWORD PTR [rdi+0x40]
 109:   mov    DWORD PTR [rsi+0x4],eax
 10c:   ret

</pre>
And on my x86 machine:
<pre class="example">[ RUN      ] ExperimentTest.SBTest1
(0, 0) : 559
(0, 1) : 999858
(1, 0) : 999576
(1, 1) : 7

</pre>
So 559 times neither core saw the other core's store.

</div>
</div>
<div id="outline-container-orga3dd0b6" class="outline-2">
<h3 id="orga3dd0b6">Load Buffering</h3>
<div id="text-orga3dd0b6" class="outline-text-2">

Load Buffering is the dual of store buffering. Loads into registers might be delayed, or buffered, and actually performed after following instructions. It's not allowed in the Intel architecture.

From the Intel White Paper
<table border="2" frame="hsides" rules="groups" cellspacing="0" cellpadding="6">
<colgroup>
<col class="org-left">
<col class="org-left">
</colgroup>
<thead><tr>
<th class="org-left" scope="col">Processor 0</th>
<th class="org-left" scope="col">Processor 1</th>
</tr></thead>
<tbody>
<tr>
<td class="org-left">mov r1, [ _x] // M1</td>
<td class="org-left">mov r2, [ _y] // M3</td>
</tr>
<tr>
<td class="org-left">mov [ _y], 1 // M2</td>
<td class="org-left">mov [ _x], 1 // M4</td>
</tr>
</tbody>
</table>
Initially x = y = 0

r1 = 1 and r2 = 1 is not allowed
<div class="org-src-container">
<pre class="src src-C++"><span class="org-constant">LB</span>::<span class="org-function-name">LB</span>() : x_(0), y_(0) {}
<span class="org-type">void</span> <span class="org-constant">LB</span>::<span class="org-function-name">t1</span>(<span class="org-type">Result</span>&amp; <span class="org-variable-name">read</span>) {
    <span class="org-constant">std</span>::get&lt;0&gt;(read) = x_.load(<span class="org-constant">std</span>::memory_order_relaxed);
    y_.store(1, <span class="org-constant">std</span>::memory_order_relaxed);
}
<span class="org-type">void</span> <span class="org-constant">LB</span>::<span class="org-function-name">t2</span>(<span class="org-type">Result</span>&amp; <span class="org-variable-name">read</span>) {
    <span class="org-constant">std</span>::get&lt;1&gt;(read) = y_.load(<span class="org-constant">std</span>::memory_order_relaxed);
    x_.store(1, <span class="org-constant">std</span>::memory_order_relaxed);
}
</pre>
</div>
This is the x86 asm code
<pre class="example">00000000000000c0 &lt;litmus::LB::t1(std::__1::tuple&lt;int, int&gt;&amp;)&gt;:
  c0:   mov    eax,DWORD PTR [rdi]
  c2:   mov    DWORD PTR [rsi],eax
  c4:   mov    DWORD PTR [rdi+0x40],0x1
  cb:   ret
  cc:   nop    DWORD PTR [rax+0x0]

00000000000000d0 &lt;litmus::LB::t2(std::__1::tuple&lt;int, int&gt;&amp;)&gt;:
  d0:   mov    eax,DWORD PTR [rdi+0x40]
  d3:   mov    DWORD PTR [rsi+0x4],eax
  d6:   mov    DWORD PTR [rdi],0x1
  dc:   ret
  dd:   nop    DWORD PTR [rax]

</pre>
And the ARM code, at -O1
<pre class="example">000000d0 &lt;litmus::LB::t1(std::tuple&lt;int, int&gt;&amp;)&gt;:
  d0:   ldr     r3, [r0]
  d4:   str     r3, [r1, #4]
  d8:   mov     r3, #1
  dc:   str     r3, [r0, #64]   ; 0x40
  e0:   bx      lr

000000e4 &lt;litmus::LB::t2(std::tuple&lt;int, int&gt;&amp;)&gt;:
  e4:   ldr     r3, [r0, #64]   ; 0x40
  e8:   str     r3, [r1]
  ec:   mov     r3, #1
  f0:   str     r3, [r0]
  f4:   bx      lr

</pre>
ARM generally allows it, but per [<a href="posts/index.php/2018/06/17/litmus-tests-for-multithreaded-behavior/#maranget2012tutorial">maranget2012tutorial</a>] it's very sensitive, and dependencies will make it not appear. In my tests, I did not observe an instance of a buffering, but it may be due to the first store the compiler introduces, in order to actually get the data into the tuple. That it's documented as possible is still exceedingly strange.

</div>
</div>
<div id="outline-container-orgb59ad3f" class="outline-2">
<h3 id="orgb59ad3f">Independent Reads of Independent Writes</h3>
<div id="text-orgb59ad3f" class="outline-text-2">

IRIW is a generalization of store buffering, where two reader threads each read different apparent orderings of writes from two distinct writer threads.
<table border="2" frame="hsides" rules="groups" cellspacing="0" cellpadding="6">
<colgroup>
<col class="org-left">
<col class="org-left">
<col class="org-left">
<col class="org-left">
</colgroup>
<thead><tr>
<th class="org-left" scope="col">T1</th>
<th class="org-left" scope="col">T2</th>
<th class="org-left" scope="col">T3</th>
<th class="org-left" scope="col">T4</th>
</tr></thead>
<tbody>
<tr>
<td class="org-left">X = 1</td>
<td class="org-left">Y = 1</td>
<td class="org-left">R1 = X</td>
<td class="org-left">R3 = y</td>
</tr>
<tr>
<td class="org-left"></td>
<td class="org-left"></td>
<td class="org-left">R2 = Y</td>
<td class="org-left">R4 = X</td>
</tr>
<tr>
<td class="org-left"></td>
<td class="org-left"></td>
<td class="org-left"></td>
<td class="org-left"></td>
</tr>
</tbody>
</table>
Initially X=Y=0
Allowed in ARM, not in x86 r1=1, r2=0, r3=1, r4=0 [<a href="posts/index.php/2018/06/17/litmus-tests-for-multithreaded-behavior/#maranget2012tutorial">maranget2012tutorial</a>,<a href="posts/index.php/2018/06/17/litmus-tests-for-multithreaded-behavior/#owens2009better">owens2009better</a>]

This is not observed in x86 processors, but is in some ARM and POWER, more often in POWER. X86 hardware has a consistent view of memory where other hardware can see memory writes in different orders on different threads. On my rPi, I didn't observe any incidents of X and Y being read out of order, over 40 million runs.
<div class="org-src-container">
<pre class="src src-C++"><span class="org-constant">IRIW</span>::<span class="org-function-name">IRIW</span>() : x_(0), y_(0) {}
<span class="org-type">void</span> <span class="org-constant">IRIW</span>::<span class="org-function-name">t1</span>() {
    x_.store(1, <span class="org-constant">std</span>::memory_order_relaxed);
}

<span class="org-type">void</span> <span class="org-constant">IRIW</span>::<span class="org-function-name">t2</span>() {
    y_.store(1, <span class="org-constant">std</span>::memory_order_relaxed);
}

<span class="org-type">void</span> <span class="org-constant">IRIW</span>::<span class="org-function-name">t3</span>(<span class="org-type">Result</span>&amp; <span class="org-variable-name">read</span>) {
    <span class="org-constant">std</span>::get&lt;0&gt;(read) = x_.load(<span class="org-constant">std</span>::memory_order_relaxed);
    <span class="org-constant">std</span>::get&lt;1&gt;(read) = y_.load(<span class="org-constant">std</span>::memory_order_relaxed);
}

<span class="org-type">void</span> <span class="org-constant">IRIW</span>::<span class="org-function-name">t4</span>(<span class="org-type">Result</span>&amp; <span class="org-variable-name">read</span>) {
    <span class="org-constant">std</span>::get&lt;2&gt;(read) = y_.load(<span class="org-constant">std</span>::memory_order_relaxed);
    <span class="org-constant">std</span>::get&lt;3&gt;(read) = x_.load(<span class="org-constant">std</span>::memory_order_relaxed);
}

</pre>
</div>
</div>
</div>
<div id="outline-container-org5fcde9b" class="outline-2">
<h3 id="org5fcde9b">Summary</h3>
<div id="text-org5fcde9b" class="outline-text-2">

The allowed behavior of modern processors is very different than our mental model of a Von Neumann architecture computer. Each core can have a different view of memory, and without additional controls, writes and reads can break the illusion of a single unified memory. The C++ memory model gives the controls and guarantees about what happens when different threads read and write memory, and here I've deliberately used the weakest version available, relaxed, in order to allow the processors the wideest latitude in behavior. Relaxed is, for processors that have it, often just an unconstrained int, which means that you will get odd behavior if you are running shared state multithreaded code that uses plain native types. It is a particular problem with code that was originally written and tested on a x86 architecture because the native model is fairly strong. This frequently causes problems when porting to a mobile platform, where ARM is a very popular hardware choice.

</div>
</div>
<div id="outline-container-org3e9feb6" class="outline-2">
<h3 id="org3e9feb6">Org-mode source and git repo</h3>
<div id="text-org3e9feb6" class="outline-text-2">

Exported from an org-mode doc. All of the source is available on github at <a href="https://github.com/steve-downey/spingate">SpinGate</a>

</div>
</div>
<div id="outline-container-org6b2f228" class="outline-2">
<h3 id="org6b2f228">References</h3>
<div id="text-org6b2f228" class="outline-text-2">
<h2 class="org-ref-bib-h1">Bibliography</h2>
<ul class="org-ref-bib">
<li>
<a id="boehm2005threads"></a>[boehm2005threads] <a name="boehm2005threads"></a>Boehm, Threads cannot be implemented as a library, 261-268, in in: ACM Sigplan Notices, edited by (2005)</li>
    <li>
<a id="bacon2000double"></a>[bacon2000double] <a name="bacon2000double"></a>@miscbacon2000double,
title=The “double-checked locking is broken” declaration,
author=Bacon, David and Bloch, Joshua and Bogda, Jeff and Click, Cliff and Haahr, Paul and Lea, Doug and May, Tom and Maessen, Jan-Willem and Mitchell, JD and Nilsen, Kelvin and others,
year=2000</li>
    <li>
<a id="IWPAug2007"></a>[IWPAug2007] <a name="IWPAug2007"></a>@miscIWPAug2007,
howpublished =
\urlhttp://www.cs.cmu.edu/~410-f10/doc/Intel_Reordering_318147.pdf,
note = Accessed: 2017-04-30,
title = Intel® 64 Architecture Memory Ordering
White Paper,</li>
    <li>
<a id="owens2009better"></a>[owens2009better] <a name="owens2009better"></a>Owens, Sarkar &amp; Sewell, A better x86 memory model: x86-TSO, 391-407, in in: International Conference on Theorem Proving in Higher Order Logics, edited by (2009)</li>
    <li>
<a id="maranget2012tutorial"></a>[maranget2012tutorial] <a name="maranget2012tutorial"></a>Maranget, Sarkar &amp; Sewell, A tutorial introduction to the ARM and POWER relaxed memory models, <i>Draft available from http://www. cl. cam. ac. uk/\~ pes20/ppc-supplemental/test7. pdf</i>, (2012).</li>
</ul>
</div>
</div>
</div>

<div id="postamble" class="status">
<p class="date">Date: 2017-04-30 Sun 00:00</p>
<p class="author">Author: Steve Downey</p>
<p class="date">Created: 2018-06-17 Sun 14:07</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>

</div>
                </div>
            </article>
</div>
    
        <ul class="pager postindexpager clearfix">
<li class="previous"><a href="." rel="prev">Newer posts</a></li>
            <li class="next"><a href="index-8.html" rel="next">Older posts</a></li>
        </ul>
<!--End of body content--><footer id="footer">
            Contents © 2024         <a href="mailto:sdowney@sdowney.dev">Steve Downey</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a> - 
 <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
 <img alt="Creative Commons License BY-NC-SA" style="border-width:0; margin-bottom:12px;" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png"></a>
            
            
        </footer>
</div>
</div>


        <script src="assets/js/all-nocdn.js"></script><script src="assets/js/luxon.min.js"></script><!-- fancy dates --><script>
        luxon.Settings.defaultLocale = "en";
        fancydates(2, {"preset": false, "format": "yyyy-MM-dd HH:mm"});
        </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script><!-- Google tag (gtag.js) --><script async src="https://www.googletagmanager.com/gtag/js?id=G-VGV27RDN3E"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-VGV27RDN3E');
</script>
</body>
</html>
